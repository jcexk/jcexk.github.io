## git限制commit大图片

#
>翻看记录上一次更新居然是一年之前了，这一年过的很快，世界风云突变，疫情却依然在肆虐，祝愿疫情早日过去，早日恢复正常生活。

需求：
>在每一次提交代码的时候，能找到本次提交包含哪些较大的图片
## 1. 什么是git hook
git在提供了一些列版本功能的功能之外，还提供了若干的扩展机制，由开发团队在其扩展点上根据需要进行定制化功能；例如，提供更为严格的提交规则检查、comment信息的检查等等。这些扩展点被成为Hook钩子。Git 通过Hook的方式，在特定的重要动作发生时触发自定义脚本。

钩子分类：客户端的和服务器端。 客户端钩子由诸如提交和合并这样的操作所调用，而服务器端钩子作用于诸如接收被推送的提交这样的联网操作。

客户端的钩子，位于git项目的.git/hooks目录之下：
![hooks路径](https://github.com/jcexk/jcexk.github.io/blob/master/imageSource/githook/githookpath.png?raw=true)

其中sample结尾的文件是由git提供的hook示例，需要的时候，只需将.sample的后缀移除，即可作为hook来使用。客户端的hook示例如下：
* pre-commit 钩子在键入提交信息前运行。
* prepare-commit-msg 钩子在启动提交信息编辑器之前，默认信息被创建之后运行
* commit-msg 钩子接收一个参数，此参数即上文提到的，存有当前提交信息的临时文件的路径
* post-commit 钩子在整个提交过程完成后运行。

其余的hook，大家可以自行检索其应用场景，使用方式大同小异。
服务端的Hook的扩展点，具体如下：
* pre-commit: 检查每次的commit message是否有拼写错误，或是否符合某种规范。
* pre-receive: 统一上传到远程库的代码的编码。
* post-receive: 每当有新的提交的时候就通知项目成员（可以使用Email或SMS等方式）。
* post-receive: 把代码推送到生产环境。

更多的扩展信息，可以参考[git的相关文档](https://git-scm.com/book/zh/v2/自定义-Git-Git-钩子)

## 2. 初始化hooks文件夹
在这里我们利用pre-commit钩子，在每次`git commit`时都去检查图片是否合规。
打开终端，cd到项目根目录中，输入`git init`，即可在`.git/hooks`路径下，找到分配的一堆sample文件了，这些就是git hook文件，其中sample结尾的文件是由git提供的hook示例，需要的时候，只需将.sample的后缀移除，即可作为hook来使用。
## 3. 创建pre-commit脚本
代码如下
```
#!/usr/bin/env python3
# coding=utf-8

import sys, subprocess
import os

def checkPictureOverLimit(gitLine):
    
    # changedCmds = ['modified:','renamed:','new file:']
    # M - 被修改，A - 被添加，D - 被删除，R - 重命名，?? - 未被跟踪
    changedCmds = [b'M',b'A']
    picChanged = False
    picPath = ''

    for gitCmd in changedCmds:
        if gitLine.startswith(gitCmd):
            picChanged = True
            path = gitLine[len(gitCmd):]
            picPath = os.path.join(os.getcwd(),(path.lstrip()).decode())
    if picChanged:
        return picOverLimitSize(picPath)
    else:
        return False, ""

kLimitSize = 100 * 1000
def picOverLimitSize(picPath):
    picSize = os.path.getsize(picPath)
    if picSize >= kLimitSize:
        limitDesc = "⚠️⚠️⚠️⚠️  " + os.path.basename(picPath) + ' ' + size_format(picSize) + " ---> Over limit. MaxSize=" + size_format(kLimitSize) + "  ⚠️⚠️⚠️⚠️"
        print(limitDesc)
        return True, limitDesc
    return False, ""

def size_format(size):
    if size < 1000:
        return '%i' % size + 'Byte'
    elif 1000 <= size < 1000000:
        return '%.1f' % float(size/1000) + 'KB'
    elif 1000000 <= size < 1000000000:
        return '%.1f' % float(size/1000000) + 'MB'
    elif 1000000000 <= size < 1000000000000:
        return '%.1f' % float(size/1000000000) + 'GB'
    elif 1000000000000 <= size:
        return '%.1f' % float(size/1000000000000) + 'TB'
        
if __name__ == "__main__":

    out = subprocess.Popen('git status -s', stdout=subprocess.PIPE, shell=True)
    #将修改的内容都放进一个list列表中
    lines = out.stdout.readlines()
    picSourceOverLimit = False
    
    print(">>>>>>>>>>>>>>>")
    #遍历检查
    for line in lines:
        line = line.strip()
        isPng = line.lower().endswith(b'.png')
        isJpg = line.lower().endswith(b'.jpg')
        isPic = isPng or isJpg
        
        #过滤1024x1024上架图，实际项目中需要替换下
        isIgnore = line.endswith(b'launchLogoTop.png')
        if isIgnore:
            continue
        #过滤非png|jpg格式
        if not isPic:
            continue
        #读取图片大小
        isOverLimit, descr = checkPictureOverLimit(line)
        if not isOverLimit:
            continue
        else:
            commit_s_file = '图片大小受限，可以考虑在githook中添加【pngquant】压缩\n'
            commit_s_file0 = descr
            if len(commit_s_file0.strip()) == 0:
                sys.exit(0)
            commit_s_file += commit_s_file0
                    
            msg = 'osascript -e \'tell application (path to frontmost application as text) to display dialog "'
            msg += commit_s_file
            msg += '" buttons{"直接提交","再检查下"} with icon stop\''
            fp = os.popen(msg)
            out1 = fp.read()
            if out1.__contains__('直接提交'):
                # 不进行后续检查，结束遍历直接提交
                picSourceOverLimit = False
                break
            else:
                # 检查
                picSourceOverLimit = True
                break
            

if picSourceOverLimit :
    print("commit中断")
    sys.exit(1)
else:
    print("commit成功")
    sys.exit(0)
```
Python相关代码已经写好注释，一目了然。

`isIgnore = line.endswith(b'launchLogoTop.png')`
在实际项目中需要过滤1024x1024的上架图，所以在这里还是需要手动改下，不能完全copy；

`kLimitSize`默认的为100kb，具体值因项目而异。

改好之后，将以上代码粘贴至`.git/hooks/pre-commit`文件中，在项目放入一张超过`kLimitSize`大小的图片之后，`git commit -m`体验下是否设置成功。成功的情况下会出现下图中的提示弹窗
![](https://github.com/jcexk/jcexk.github.io/blob/master/imageSource/githook/commitSuccess.png?raw=true)
* 直接提交：绕过picSizeLimit限制，和常规commit一样提交到版本库。
* 再检查下：中断commit，可以根据提示找到该图片进行压缩处理。

在`git commit`时，可能会提示`fatal: cannot exec '.git/hooks/pre-commit': Operation not permitted`错误，
            
解决办法：
1. 确认pre-commit是读写权限
2. cd到pre-commit同级目录下，终端输入`ls -l@ pre-commit`
3. 输入`xattr -d com.apple.quarantine pre-commit`，`xattr -d com.apple.metadata:kMDLabel_27y33viiqg7obksweki6fhh6k4 pre-commit`
            。如下图所示：
            
![permitted](https://github.com/jcexk/jcexk.github.io/blob/master/imageSource/githook/commit-error.png?raw=true)

## 4. 同步hook文件
因为hook是在.git文件夹下，不能通过git管理，所以要做到多人协同开发，需要将hook脚本同步给其他人将上述`pre-commit`脚本放在项目目录下，比如`./shell/pre-commit(根目录/shell/pre-commit)`，这样就能通过git进行管理。
上述做法虽然可以解决脚本同步问题，但不够自动化，还是需要其他人手动把git仓库中的pre-commit复制到.git/hooks/目录下。如果有新同事参与项目，可能会忘了这步操作。
接下来，我们将利用
`Xcode的"Run Script"`功能，来解决上述问题。

```
#!/bin/bash

if [ -f ./.git/hooks/pre-commit ]; then
    echo "pre-commit已经设置过"
else
    if [ -f ./shell/pre-commit ]; then
        echo "pre-commit文件存在"
    else
        echo "pre-commit文件不存在"
        exit 1
    fi

    if [ -f ./.git/hooks/pre-commit.sample ]; then
        rm ./.git/hooks/pre-commit.sample
    fi

    echo "pre-commit未设置，开始设置"
    cp  ./shell/pre-commit ./.git/hooks/pre-commit
    echo "pre-commit设置成功"
fi
````
代码也很简单，就是些文件的移动操作。
在Xcode的Build Phases中新建一个`Run Script`，并把上述代码粘贴过去。
重新编译，通过查看编译信息和.git/hooks文件，可以看到pre-commit已经转移成功。
接下来，让我们一起愉快的玩耍吧。
![](https://github.com/jcexk/jcexk.github.io/blob/master/imageSource/githook/build-success.png?raw=true)

待优化：git hook添加压缩功能，超限图片列表功能(目前只实现单个文件的提示，感觉不是很好)。

未完待续......